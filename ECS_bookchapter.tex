\documentclass[preprint,11pt,authoryear]{elsarticle}
\pdfoutput=1
\pdfminorversion=4 %had problems submitting a v1.5 pdf file with J Neurosci Methods
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{esint}
\usepackage{amssymb}
\usepackage{lineno}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage[]{algorithm}
\usepackage[noend]{algpseudocode}
%% natbib.sty is loaded by default. However, natbib options can be
%% provided with \biboptions{...} command. Following options are
%% valid:

%%   round  -  round parentheses are used (default)
%%   square -  square brackets are used   [option]
%%   curly  -  curly braces are used      {option}
%%   angle  -  angle brackets are used    <option>
%%   semicolon  -  multiple citations separated by semi-colon
%%   colon  - same as semicolon, an earlier confusion
%%   comma  -  separated by comma
%%   numbers-  selects numerical citations
%%   super  -  numerical citations as superscripts
%%   sort   -  sorts multiple citations according to order in ref. list
%%   sort&compress   -  like sort, but also compresses numerical citations
%%   compress - compresses without sorting
%%
%% \biboptions{comma,round}

% \biboptions{}

\bibliographystyle{elsarticle-harv}
\biboptions{square}

\renewcommand\familydefault{\sfdefault}
\usepackage[scaled]{helvet}

\usepackage{units}
\usepackage[usenames, dvipsnames]{xcolor}

\usepackage{soul}
\usepackage{placeins}

\usepackage{nameref}
\usepackage[pdftex,breaklinks=true,colorlinks=true,linkcolor=blue,citecolor=blue,urlcolor=blue,filecolor=blue,pdffitwindow,backref=true,pagebackref=false,bookmarks=true,bookmarksopen=true,bookmarksnumbered=true]{hyperref}
\usepackage[plain]{fancyref}
\usepackage{array}
\usepackage{multirow}

% Text layout
%\hoffset 2 cm
\topmargin 0.0cm
\oddsidemargin 0.5cm
\evensidemargin 0.5cm
\textwidth 16cm 
\textheight 21cm

%custom color for \hlc
\newcommand{\hlc}[2][yellow]{ {\sethlcolor{#1} \hl{#2}} }
\newcommand{\hlb}[2][blue]{ {\sethlcolor{#1} \hl{#2}} }
\newcommand{\hlr}[2][Maroon]{ {\sethlcolor{#1} \hl{#2}} }
\newcommand{\hlj}[2][OliveGreen]{ {\sethlcolor{#1} \hl{#2}} }
\newcommand{\hlR}[2][red]{ {\sethlcolor{#1} \hl{#2}} }
\newcommand{\hlp}[2][Purple]{ {\sethlcolor{#1} \hl{#2}} }
\newcommand{\hlt}[2][Tealblue]{ {\sethlcolor{#1} \hl{#2}} }

%boxes and highlight color for text updates, personified!
\newcommand{\ghnote}[1]{\color{white}{\hlb{GH: #1 }}\color{black}}
\newcommand{\ghtxt}[1]{{\color{blue}#1}}
\newcommand{\gtenote}[1]{\color{white}{\hlR{GTE: #1 }}\color{black}}
\newcommand{\gen}[1]{\color{white}{\hlR{GTE: #1 }}\color{black}}
\newcommand{\gtetxt}[1]{{\color{red}#1}}
\newcommand{\gex}[1]{{\color{red}#1}}
\newcommand{\genn}[1]{{\color{orange}#1}}

\newcommand{\tvnnote}[1]{\color{white}{\hlj{TVN: #1 }}\color{black}}
\newcommand{\tvntxt}[1]{{\color{OliveGreen}#1}}

\newcommand{\snnote}[1]{\color{white}{\hlp{SN: #1 }}\color{black}}
\newcommand{\sntxt}[1]{{\color{Purple}#1}}
\newcommand{\slntxt}[1]{{\color{RoyalPurple}#1}}


%fancy ref formatting
\Frefformat{plain}{\fancyreffiglabelprefix}{Fig~#1}
\newcommand*{\Frefsecshortname}{Section}%
\Frefformat{plain}{\fancyrefseclabelprefix}{\Frefsecshortname~#1}
\Frefformat{plain}{\fancyrefeqlabelprefix}{Eq~(#1)}

%tables as in Nordlie et al. (2009)
\usepackage{tabularx}
\usepackage{colortbl}
\usepackage{morefloats}

%table formatting
\newcommand{\modelhdr}[3]{%
   \multicolumn{#1}{|l|}{%
     \color{white}\cellcolor[gray]{0.0}%
     \textbf{\makebox[0pt]{#2}\hspace{0.5\linewidth}\makebox[0pt][c]{#3}}%
   }%
}
\newcommand{\parameterhdr}[3]{%
   \multicolumn{#1}{|l|}{%
     \color{black}\cellcolor[gray]{0.8}%
     \textbf{\makebox[0pt]{#2}\hspace{0.5\linewidth}\makebox[0pt][c]{#3}}%
   }%
}
\def\tabspace{0.5ex}

\usepackage{float}
\floatstyle{plaintop}
\restylefloat{table}

\journal{nobody}


% redefinition of \author{â€¢} because of bug (reset of \@corref missing), taken from:
% http://tex.stackexchange.com/questions/116515/elsarticle-frontmatter-corresponding-author
%
\makeatletter
\def\@author#1{\g@addto@macro\elsauthors{\normalsize%
    \def\baselinestretch{1}%
    \upshape\authorsep#1\unskip\textsuperscript{%
      \ifx\@fnmark\@empty\else\unskip\sep\@fnmark\let\sep=,\fi
      \ifx\@corref\@empty\else\unskip\sep\@corref\let\sep=,\fi
      }%
    \def\authorsep{\unskip,\space}%
    \global\let\@fnmark\@empty
    \global\let\@corref\@empty  %% Added
    \global\let\sep\@empty}%
    \@eadauthor={#1}
}
\makeatother

% - mine pakker -
\usepackage[exponent-product = \cdot]{siunitx}
\usepackage[colorinlistoftodos]{todonotes}
\usepackage[normalem]{ulem} % strikethroughs \sout{Hello World}
\usepackage{caption}
\usepackage{booktabs} % to make nice tables
\graphicspath{{Figures/}} %Setting the graphicspath
\usepackage{caption}
\usepackage{subcaption}

% - mine kommandoer - 


\begin{document}

\begin{frontmatter}

%% Title, authors and addresses

\title{Computing extracellular electrical potentials from neuronal simulations} 

%% use the tnoteref command within \title for footnotes;
%% use the tnotetext command for the associated footnote;
%% use the fnref command within \author or \address for footnotes;
%% use the fntext command for the associated footnote;
%% use the corref command within \author for corresponding author footnotes;
%% use the cortext command for the associated footnote;
%% use the ead command for the email address,
%% and the form \ead[url] for the home page:
%%
%% \title{Title\tnoteref{label1}}
%% \tnotetext[label1]{}
%% \author{Name\corref{cor1}\fnref{label2}}
%% \ead{email address}
%% \ead[url]{home page}
%% \fntext[label2]{}
%% \cortext[cor1]{}
%% \address{Address\fnref{label3}}
%% \fntext[label3]{}

%% use optional labels to link authors explicitly to addresses:
%% \author[label1,label2]{<author name>}
%% \address[label1]{<address>}
%% \address[label2]{<address>}

\author{Geir Halnes\fnref{label1,label2}}
\author{Torbj\o{}rn V. Ness \fnref{label1}}
\author{Solveig N\ae{}ss\fnref{label2}}
\author{Klas H. Pettersen \fnref{label3}}
\author{Gaute T. Einevoll\corref{cor1}\fnref{label1,label2,label4}}

\address[label1]{Faculty of Science and Technology, Norwegian University of Life Sciences, {{\AA}}s, Norway}
\address[label2]{Center for Integrative Neuroplasticity, University of Oslo, Oslo, Norway}
\address[label3]{Norwegian Artificial Intelligence Research Consortium, Oslo, Norway}
\address[label4]{Department of Physics, University of Oslo, Oslo, Norway}

\cortext[cor1]{correspondence: \href{geir.halnes@nmbu.no}{gaute.einevoll@nmbu.no}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{abstract}
%% Text of abstract
\ghnote{Vet ikke hva forfatterordningen skal vaere, men vi faar se det an etter hvert, og bestemme utifra hvem som har jobbet mest med manus. For oeyeblikket leder jeg, men jeg tror jeg satser paa at kanskje Torbjoern fosser forbi etter hvert.}
\tvnnote{Just to be sure: If we make figures for this chapter, we have the right to re-use those wherever we like?}
\tvnnote{Giugliano: max 15-20 pages, by February 2020 }
\end{abstract}

\begin{keyword}
extracellular potentials \sep LFP \sep EEG \sep ECoG \sep electrodiffusion
%% keywords here, in the form: keyword \sep keyword

%% MSC codes here, in the form: \MSC code \sep code
%% or \MSC[2008] code \sep code (2000 is the default)
\end{keyword}

\end{frontmatter}

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Start line numbering here if you want
\linenumbers

\section{Introduction}
\label{sec:introduction}

Arguably, most of what we have learned about the mechanisms by which neurons and networks operate in living brains comes from recordings of 
extracellular potentials. In such recordings, electrical potentials are measured by electrodes that are either placed between cells in brain tissue (spikes, LFPs), at the cortical surface (ECoG, electrocorticography), or at the scalp (EEG, electroencephalograpy) (Figure~\ref{fig:multimodal}). Spikes, the high-frequency part of the extracellular potentials recorded inside gray matter, are reliable signatures of neuronal action potentials, and spike measurements have been instrumental in mapping out, for example, receptive fields accounting for how sensory stimuli are represented in the brain. The analysis of the LFP signal, the low-frequency part of electrical potentials recorded inside gray matter, as well the ECoG, and EEG signals is less straightforward. Interpretation of the signal in terms of the underlying neural activity has been difficult, and most analysis of the data has been purely statistical~\citep{Nunez2006,Buzsaki2012,Einevoll2013,Ilmoniemi2019}.

The tradition of physics is different. Here candidate hypotheses are typically formulated as specific mathematical models, and predictions computed from the models are compared with experiments. In neuroscience this approach has been used to model activity in individual neurons using, for example, biophysically detailed neuron models based on the cable equation formalism (see, e.g., \citet{Koch1999,Sterratt2011}).  
Here the models have largely been developed and tested by comparison with membrane potentials recorded by intracellular electrodes in 
\emph{in vitro} settings (but see \citet{Gold2007}).
To pursue this mechanistic approach to network models in layered structures such as cortex or hippocampus, 
one would like to compare model predictions with all available experimental data, that is, not only spike times recorded for a small subset of the neurons, but also population measures such as LFP, ECoG and EEG signals~\citep{Einevoll2019}. This chapter addresses how to model such electrical population signals from neuron and network models.

In addition to allowing for validation on large-scale network models mimicking specific biological 
networks, e.g., \citet{Reimann2013,Markram2015,Billeh2020}, we believe a key application is to generate  
model-based benchmarking data for validation of data analysis methods~\citep{Denker2012}.
One example is the use such benchmarking data to develop and test spike-sorting methods~\cite{Hagen2016, Buccino2019}
or test methods for localization and classification of cell types~\citep{DelgadoRuz2014, Buccino2018}.
Another example is testing of methods for analysis of LFP signals, such as CSD analysis~\citep{Pettersen2008,Leski2011,Ness2015} or 
ICA analysis~\citep{Glabska2014}, or joint analysis of spike and LFP signals such as laminar population analysis (LPA)~\citep{Glabska2016}.

The standard way to compute extracellular potentials from neural activity is a two-step process~\citep{Holt1999,Linden2014,Hagen2018}:
%
\begin{enumerate}
\item Compute the net transmembrane current in all neuronal segments in (networks of) biophysically-detailed neuron models, and
\item use volume-conductor (VC) theory to compute extracellular potentials from the these computed transmembrane currents.
\end{enumerate}
%
This book chapter describes the origin of VC theory, that is, how it can be derived from a more detailed electrodiffusive theory describing
dynamics of ions in the extracellular media. It also provides examples where our tool LFPy (\texttt{LFPy.github.io}) \citep{Linden2014,Hagen2018}
is used to compute spikes, LFP signals and EEG signals generated by neurons and neuronal populations.

%%%
\begin{figure}[!ht]
\begin{center}
\includegraphics[width=0.8\textwidth]{cortex_multipop}
\end{center}
\caption{\textbf{LFP, ECoG and EEG.} The same basic building blocks, that is, currents caused by large numbers of synaptic input are contributing to several different measurable signals.
}
\label{fig:multimodal}
\end{figure}
%%%




%The link between membrane currents and the extracellular potential is of course mediated by electrical currents. Electrical currents in the brain are mediated by the movement of ions, and it is these currents that a recording electrode pick up.  A net electrical current through the extracellular space of the brain could in principle include several components, such as (1) a drift component (ions migrate in electrical fields), (2) a diffusion component (ions diffuse), (3) an advective component (extracellular fluid flow drags ions along), and (4) a displacement component (ions pile up and changes the local charge density). Since the extracellular bulk fluid has very fast relaxation times and is very close to electroneutral, the latter two current components (3-4) are extremely small and are typically neglected \citep{Grodzinsky2011, Gratiy2017}. The diffusive component (3) is acknowledged to play an important role for voltage dynamics on a tiny spatial scale, such as in synaptic clefts or in the close vicinity of neuronal membrane, where ion concentrations can change dramatically within very short time \citep{Savtchenko2017, Pods2017}. At the level of tissue, it is commonly believed that the diffusive current is much smaller than the drift current, so that even diffusive currents are typically neglected \citep{Holt1999, Pettersen2008a}. This is often a useful approximation, since modeling of electrodiffusive processes is computationally expensive and may not be feasible for large and complex systems. However, if concentration gradients are present, diffusive currents could in principle affect measurable extracellular potentials \citep{Halnes2016, Halnes2017, Solbra2018}, and in scenarios involving dramatic shifts in extracellular concentrations, such as spreading depression and related pathologies, diffusive effects are likely to be of key importance for shaping the extracellular potential \citep{Almeida2004, OConnell2016}.


%how one, based on knowing the transmembrane currents, can compute the electrical potential in the extracellular space surrounding the active neurons. 
%
%We start this book chapter by giving an overview of the theory used for forward modeling of extracellular potentials, and introduce the mathematical frameworks and software tools that can be used for such modeling. We start the theory-part at the rather fundamental level of electrodiffusive ion concentration dynamics, and derive an electrodiffusive framework for predicting the dynamics of the extracellular ion concentrations and potential. We next show how this theory can be reduced to the simpler, and more common VC-theory if we assume that the diffusive component is negligible. 


\section{%Theory: 
From electrodiffusion to volume conductor theory}
\label{sec:theory}

The recorded extracellular potentials are generated by electrical currents, that is, movement of ions, in the extracellular space.
Such an extracellulal electrical current can in principle include several components:
%
\begin{enumerate}
\item a drift component (ions migrating in electrical fields), 
\item a diffusion component (ions diffusing due to concentration gradients),
\item an advective component (extracellular fluid flow drags ions along), and
\item a displacement component (ions pile up and changes the local charge density). 
\end{enumerate}
%
Since the extracellular bulk fluid has very fast relaxation times and is very close to electroneutral, the latter two current components (3-4) are extremely small and are typically neglected \citep{Grodzinsky2011, Gratiy2017}. The diffusive component (2) is acknowledged to play an important role for voltage dynamics on a tiny spatial scale, such as in synaptic clefts or in the close vicinity of neuronal membrane, where ion concentrations can change dramatically within very short time \citep{Savtchenko2017, Pods2017}. At macroscopic tissue level, it is commonly believed that the diffusive current is much smaller than the drift current, so that even diffusive currents are typically neglected so that only the drift component (1) is considered. Then the extracellular medium is considered to be a volume conductor (VC) which greatly simplifies the calculation of extracellular potentials~\citep{Holt1999, Linden2014}.

However, if large ion-concentration gradients are present, diffusive currents could in principle affect measurable extracellular potentials \citep{Halnes2016, Halnes2017, Solbra2018}. Thus in scenarios involving dramatic shifts in extracellular concentrations, such as spreading depression and related pathologies, diffusive effects are likely to be of key importance for shaping the extracellular potential \citep{Almeida2004, OConnell2016}. If so, VC theory is insufficient, and computationally much more expensive electrodiffusive modeling must be used instead.

In this section we start with a very general assumption of how ions moving through the brain under the combined influence of electric fields and concentration gradients. Building on this, we then first describe several computational schemes for modelling electrodiffusive processes before we derive the fundamental equations for VC theory assuming negligible effects from diffusion.


\subsection{Ion concentration dynamics}
\label{sec:eldiff}
The movement of ions, that is, charged atoms or molecules, in the brain are described in terms of the flux, and there are essentially two different processed that cause ions to move in the brain, namely diffusion and electrical drift.
In \tvntxt{such} electrodiffusive processes, the flux density of an ion species $k$ is given by \citep{Koch1999}:
%%%
\begin{equation}
{\bf j_k} = - D_{k} {\bf \nabla} c_{k} - \frac{D_k z_k c_k}{\psi} {\bf \nabla} \phi,
\label{eq:JNP}
\end{equation}
%%%
where the first term on the right is Fick's law for the diffusive flux density $j_{k}^\text{diff}$, and the second term is the drift flux density $j_{k}^\text{drift}$, which expands Fick's law in the case where the diffusing particles also move due to electrostatic forces with a mobility $D_k/\psi$ (cf. the Einstein-relation, \cite{Mori2008}). Here $D_{k}$ is the diffusion coefficient of ion species $k$, $\phi$ is the electric potential, $z_{k}$ is the valency of ion species $k$, and $\psi=RT/F$ is defined by the gas constant ($R$), Faraday's constant ($F$)  and the temperature ($T$). The ion concentration dynamics of a given species is then given by the Nernst-Planck continuity equation:

\begin{equation}
\frac{\partial c_k}{\partial t} = - {\bf \nabla} \cdot {\bf j_k} + f_k = {\bf \nabla} \cdot \left[ D_k {\bf \nabla} c_k + \frac{D_k z_k c_k}{\psi} {\bf \nabla} \phi \right] + f_k
\label{eq:NP}
\end{equation}
where $f_k$ represents any source term in the system, such as e.g., an ionic transmembrane current source \citep{Solbra2018}. 

In order the solve a set (i.e., one for each ion species present) of equations like eq.~\ref{eq:NP}, one needs an expression for the electrical potential $\phi$. There are two main approaches to this. The physically most detailed approach is to use the Poisson-Nernst-Planck (PNP) formalism \citep{Leonetti1998, Leonetti2004, Lu2007, Lopreore2008, Nanninga2008, Pods2013, Gardner2015}. Then $\phi$ is determined from Poisson's equation from electrostatics, 
\begin{equation}
\nabla^2 \phi = -\rho/\epsilon, 
\label{eq:poisson}
\end{equation}
where $\epsilon$ is the permittivity of the system, and $\rho$ is the charge density associated with the ionic concentrations, as given by:
\begin{equation}
\rho = F \sum_k z_k c_k.
\label{eq:F}
\end{equation}
An alternative, more computationally efficient approach is to replace the Poisson equation with the simplifying approximation that the bulk solution is electroneutral \citep{Mori2008, Mori2009, Mori2009a, Mori2011, Halnes2015, Halnes2013, Pods2017, Niederer2013, OConnell2016, Solbra2018}, which is a good approximation on spatiotemporal scales larger than micrometers and microseconds \citep{Grodzinsky2011, Pods2017, Solbra2018}. 

Both the PNP formalism and the electroneutral formalism allow us to compute the dynamics of ion concentrations and the electrical potential in the extracellular space of neural tissue containing an arbitrary set of neuronal and glial current sources. For example, in recent work, a version of the electroneutral formalism called the Kirchhoff-Nernst-Planck (KNP) formalism was developed into a framework for computing the extracellular dynamics (of $c_k$ and $\phi$) in a 3D space surrounding morphologically complex neurons simulated with the NEURON simulation tool \citep{Solbra2018}. However, both the PNP and electroneutral formalisms such as KNP keep track of the spatial distribution of ion concentrations, and as such they require a suitable meshing of the 3D space, and numerical solutions based on finite difference- or finite element methods. In both cases, simulations can become very heavy, and for systems at a tissue level the required computational demand may be too large to be feasible. For that reason, there is much to gain from deriving a simpler framework where effects of ion concentration dynamics are neglected, since, for many scenarios, this may be a good approximation. Below, we will derive this simpler frameworks, i.e., the standard volume conductor (VC) theory, using the Nernst-Planck fluxes (eq.~\ref{eq:JNP}) as a starting point.

\subsection{Electrodynamics}
If we multiply eq.~\ref{eq:JNP} by $F\cdot z_k$ and take the sum over all ion species, we get an expression for the net electrical current density due to all particle fluxes:

\begin{equation}
{\bf i} = - \sum_k{F z_k D_{k}{\bf \nabla} c_{k}} - \sigma {\bf \nabla}{\phi}
\label{eq:INP}
\end{equation}
where the first term is the diffusive current density $i^\text{diff}$ and the second term is the drift current density $i^\text{drift}$. We have here identified the conductivity $\sigma$ of the medium as \citep{Koch1999}:
\begin{equation}
\sigma = F\sum_{k} \frac{\tilde{D}_{k} z_{k}^2}{\psi}c_{k}.
\label{eq:sigma}
\end{equation}
Current conservation in the extracellular space implies that:
\begin{equation}
{\bf \nabla} \cdot {\bf i} = - \sum_k{F z_k D_{k}\nabla^2 c_{k}} - {\bf \nabla} \cdot (\sigma {\bf \nabla} \phi) = - C,
\label{eq:CSD}
\end{equation}
where $C$ denotes the current source density (CSD), reflecting e.g., local neuronal or glial transmembrane currents. 
We note that this is essentially equivalent to eq.~\ref{eq:NP} at the level of single ion species, with the exception that eq.~\ref{eq:NP} contains a term $\partial c_k/ \partial t$ for accumulation of ion species $k$, while eq.~\ref{eq:CSD} does \emph{not} contain a corresponding term ($\partial \rho/ \partial t$) for charge accumulation. Hence, in eq.~\ref{eq:CSD} it is implicitly assumed that the extracellular bulk solution is electroneutral \citep{Solbra2018}. We note that in general, the $CSD$ term includes both ionic transmembrane currents and transmembrane capacitive currents, and that the latter means that the local charge accumulation building up the transmembrane potential still occurs in the membrane Debye-layer.

Note that if we assume all concentrations to be constant in space, the diffusive term vanishes, and eq.~\ref{eq:CSD} reduces to:
\begin{equation}
{\bf \nabla} \cdot (\sigma {\bf \nabla} \phi) = - C.
\label{eq:CSDstandard}
\end{equation}
This the standard expression used in CSD theory \citep{Mitzdorf1985, Nicholson1975, Pettersen2006}, where spatially distributed recordings of $\phi$ are used to make theoretical predictions of underlying current sources. When using eq.~\ref{eq:CSDstandard}, it is implicitly assumed that the Laplacian of $\phi$ exclusively reflects transmembrane current sources, and that it is not contributed to by diffusive processes. 

We note there are two conventions for defining the variables in eqns. \ref{eq:JNP}-\ref{eq:CSDstandard}, both of which are in use. The variables can be defined either relative to a tissue reference volume or relative to an extracellular reference volume. The former convention is the common convention used in volume conductor theory. Then concentrations denote the number of extracellular ions per unit tissue volume, sources denote the number of ions/the net charge per unit tissue volume per second, and flux/current densities are defined per unit tissue cross-section area. Then, $\sigma$ interprets as the conductivity experienced by the current density per tissue cross section area. 

As eq.~\ref{eq:CSD} indicates, also diffusive processes can in principle contribute to the Laplacian of $\phi$, and if present, they could give rise to a non-zero Laplacian of $\phi$ even in the absence of neuronal sources ($C=0$). Previous computational studies have predicted that effects of diffusion on extracellular potentials are not necessarily small, but tend to be very slow, meaning that they will only affect the very low-frequency components of $\phi$ \citep{Halnes2016, Halnes2017}. This is due to the diffusive current being a direct function of ion concentrations $c_k$, which on a large spatial scale typically vary on a much slower time scale (seconds-minutes) than the fluctuations in $\phi$ that we commonly are interested in (milliseconds-seconds). Furthermore, electrodes used to record $\phi$ typically have a lower cutoff frequency of 0.1-1~Hz \citep{Einevoll2013}, which means that most of the tentative diffusive contribution will be filtered out from experimental recordings. It may therefore be a good approximation to neglect the diffusive term, except in the case of pathologically dramatic concentration variations. For the rest of this chapter, we shall do so, and assume that electrodynamics in neural tissue can be determined by eq.~\ref{eq:CSDstandard}.




\subsection{Volume conductor theory}
%\snnote{I've made some letters boldface and added a few unit vectors to ensure that ${\bf \nabla}$ always is a vector. Torbjorn: Do you agree?}
%\tvnnote{Looks good to me}
\label{sec:VC_theory}
In simulations of morphologically complex neurons, we typically compute a set of transmembrane current sources for each neuronal segment \citep{Koch1999}. Commonly, one assumes that the extracellular potential does not affect the neurons (i.e., no ephaptic coupling), since extracellular potentials are typically much smaller than the membrane potential of $\sim$-70~mV. 
By assuming that the tissue medium can be approximated as a volume conductor \citep{Holt1999, Linden2014}, one can then use the standard CSD equation (eq.~\ref{eq:CSDstandard}) to perform a forward modeling of the extracellular potential at each point in space surrounding the neuron(s). 

If we consider the simple case of a single point-current source $I_1$ at the origin in an isotropic medium, the current density ${\bf i} = -\sigma {\bf \nabla} \phi$ through a spherical shell with area $4\pi r^2$ must, due to the spherical symmetry, equal $I_1/4\pi r^2~{\bf \hat{r}}$. %${\bf \nabla} \phi = \partial \phi/ \partial r~{\bf \hat{r}}$, and 
Integration with respect to $r$ gives us:
%%%
\begin{equation}
\phi = \frac{I_1}{4\pi \sigma r},
\label{eq:pointsource}
\end{equation}
%%%
where $r$ is the distance from the source. %\tvnnote{OK?}\snnote{perfect!}

If we have several point-current sources, $I_{1}, I_2, I_3, ... $, in locations ${\bf r}_1, {\bf r}_2, {\bf r}_3 ... $, their contributions add up due to the linearity assumption (see sec.~\ref{sec:VC_assumptions}), and the potential in a point ${\bf r}$ is given by:
%%%
\begin{equation}
\phi({\bf r}) = \frac{I_1}{4\pi  \sigma {\bf |r-r}_1|} + \frac{I_2}{4\pi  \sigma {\bf |r-r}_2| } + \frac{I_3}{4\pi  \sigma {\bf |r-r}_3| } + ... = \sum_k \frac{I_k}{4\pi  \sigma {\bf |r-r}_k| }.
\label{eq:VCtheory}
\end{equation}
%%%
Eq.~\ref{eq:VCtheory} is often referred to as the point-source approximation \citep{Holt1999, Linden2014}, since the membrane current from a neuronal segment is assumed to enter the extracellular medium in a single point. An often used further development is obtained by integrating eq.~\ref{eq:VCtheory} along the segment axis, corresponding to the transmembrane current being evenly distributed along the segment axis, giving the line-source approximation \citep{Holt1999, Linden2014}.

\subsubsection{Current-dipole approximation}
%\tvnnote{Jeg skrev om litt her}
When estimating the extracellular potential far away from a volume containing a combination of current sinks and sources, 
it can often be useful to express eq.~\eqref{eq:VCtheory} in terms of a multipole expansion. 
That is, $\phi$
can be precisely described by \citep{Nunez2006},
\begin{equation}\label{eq:multipole}
\phi(R) = \frac{C_\text{monopole}}{R} + \frac{C_\text{dipole}}{R^2} + \frac{C_\text{quadrupole}}{R^3} + \frac{C_\text{octupole}}{R^4} + ... ,
\end{equation}
when the distance $R$ from the center of the volume to the measurement point is larger than the distance from volume center to the most peripheral source \citep{Jackson1998}. 
%Here, the monopole contribution $C_{monopole}$, dipole contribution $C_{dipole}$ and quadrupole contribution $C_{quadrupole}$, etc., are \snnote{somehow} defined in \cite{Riera2012}.


In neural tissue, there will be no current monopole contribution to the extracellular potential,  
that is, $C_\text{monopole}=0$. This follows from the requirement inherent in the cable equation that the sum over all transmembrane currents, including the capacitive currents, across the neuronal surface has to be zero at all points in time~\citep{Pettersen2012}.
Further,
the quadrupole, octupole and higher-order contributions decay rapidly with distance $R$. Consequently, the multipole expansion can be approximated by the dipole contribution for large distances, a simplification known as the current-dipole approximation \citep{Nunez2006}:

%%%
\begin{equation}\label{eq:CDA}
\phi(\mathbf{R}) \approx \frac{C_\text{dipole}}{R^2} = \frac{1}{4 \pi \sigma} \frac{|\mathbf{p}| \cos \theta}{R^2}.
\end{equation}
%%%
Here, $\mathbf{p}$ is the current dipole moment and $\theta$ is the angle between the current dipole moment and the distance vector $\mathbf{R}$. The current dipole moment can be found by summing up all the position-weighted transmembrane currents from a neuron \citep{Pettersen2008, Pettersen2014, Nunez2006}: 
%%%
\begin{equation}\label{eq:dipole}
\mathbf{p} = \sum_{k=1}^N I_k \mathbf{r}_k.
\end{equation}
%%%

In the case of a two-compartment neuron model (see Section~\ref{sec:ExtracellularPotentials}) with a current sink $-I$ at location $\mathbf{r}_1$ and a current source $I$ at location $\mathbf{r}_2$, the current dipole moment can be formulated as $\mathbf{p} = -I\mathbf{r}_1 + I\mathbf{r}_2 = I(\mathbf{r}_2 - \mathbf{r}_1) = I\mathbf{d}$, where $\mathbf{d}$ is the distance vector between the current sink and the current source, giving the dipole length $d$ and direction of the current dipole. The current-dipole approximation is applicable in the far-field limit, that is when $R$ is much larger than the dipole length. \gex{For an investigation of the applicability of this approximation for the LFP generated by a single neuron, 
see \cite{Linden2010}.} 

\sout{
In general, this means when $R > 3d$ or $R > 4d$. Specifically, when computing the extracellular potential from a single apical synaptic input to a pyramidal cell, found that the measurement point must be about 1-2 mm away from the cell for the approximation to be applicable.}
\gen{I Linden2010 viser vi noen beregninger for konkrete nevronmodeller som jeg vil tro kan gi et bedre grunnlag for en tommelfingerregel enn Nunez2006.}
\snnote{Hva med dette?}
\gen{Kanskje vi kan avslutte dette avsnittet med setningen som starter med "For an investigation ..."? Usikker paa hvordan Nunez kom frem til sitt estimat.} 
\


\subsubsection{Assumptions in volume conductor theory}
\label{sec:VC_assumptions}
The point-source approximation, eq.~\ref{eq:VCtheory} (or the line-source version of it), and the current-dipole approximation, eq.~\eqref{eq:CDA}, represent volume conductor theory in its simplest form, and are based on a set of assumptions, some of which may be relaxed for problems where it is relevant: 

\begin{enumerate}

\item {\bf Quasi-static approximation of Maxwell's equations:} Terms with time derivatives of the electrical and magnetic fields are neglected. This approximation appears to be well-justified for the relatively low frequencies relevant for brain signals, below about 10 kHz \citep{Nunez2006}.

\item {\bf Linear extracellular medium:} Linear relationship ($\bf{i} = -\sigma {\nabla \phi}$) between the current density ${\bf i}$ and the electrical field, $\nabla \phi$. This is essentially Ohm's law for volume conductors, and the relation is constitutive, meaning that it is observed in nature rather than derived from any physical principle \citep{Nunez2006, Pettersen2012}.

\item {\bf Frequency-independent conductivity:} Capacitive effects in neural tissue are assumed to be negligible compared to resistive effects in volume conduction. This approximation seems to be justified for the relevant frequencies in extracellular recordings \citep{Logothetis2007, Miceli2017, Ranta2017}, see Fig.~\ref{fig:freq_dep}. Note that it is possible to expand the formalism to include a frequency-dependent conductivity \citep{Tracey2011, Miceli2017}. 

\item {\bf Isotropic conductivity:} The electrical conductivity, $\sigma$, is assumed to be the same in all spatial directions. 
Cortical measurements have indeed found the conductivities to be comparable across different lateral directions in cortical grey matter \citep{Logothetis2007}. However, the conductivity in the depth direction, i.e., parallel to the long apical dendrites, was found to be up to 50\% larger than in the lateral direction in rat barrel cortex \citep{goto2010}. Anisotropic electrical conductivities have also been found in other brain regions, for example in frog cerebellum \citep{Nicholson1975} and in guinea-pig hippocampus \citep{holsheimer1987}. The approximation that $\sigma$ is homogeneous is still often acceptable, as it normally gives fairly good estimations of the extracellular potential, at least in cortical tissue \citep{Ness2015}. However, it is relatively straightforward to expand the formalism to account for anisotropic conductivities \citep{Ness2015}.

%\gen{Kan kanskje vaere mer presis her. Det er vel stoerre anisotropi i hippocampus enn i cortex? Se Pettersen2012.}
%\ghnote{GH: Vet ikke med hippocampus. Jeg fant noe om layer-spesific sigma, som jeg la inn under Homogeneous, under. Det nye i teksten over sakset jeg stort sett fra Ness 2015. Torbjorn, kan du se paa dette? Paastanden om at iso-sigma approksimasjonen gir ok estiamater for potensialet mener jeg aa ha sett deg skrive et sted, men husker ikke helt hvor. Er den berettiget, og har vi en referanse?}
%\tvnnote{Jeg er nok en litt cortexistisk person. Det er ikke det at jeg missliker andre hjernedeler, jeg bare tenker sjelden paa de naar jeg skriver. Sann det staar naa, er jo baade hippocampus og cerebellum nevnt som mulige unntak, er det greit? Vi har kun testet i cortex (Ness et al. 2015), og fant da i praksis veldig liten effekt av 50 prosent anisotropi.}

\item {\bf Homogeneous  conductivity:} The extracellular medium was assumed to have the same conductivity everywhere. Although neural tissue is highly non-homogeneous on the micrometer scale \citep{Nicholson1998}, microscale inhomogeneities may average out on a larger spatial scale, and a homogeneous conductivity seems to be a reasonable approximation within cortex \citep{Logothetis2007}. In hippocampus, however, the conductivity has been found to be layer-specific \citep{lopez2001}. In situations where the assumption of a homogeneous conductivity is not applicable, eq.~\ref{eq:CSDstandard} can always be solved for arbitrarily complex geometries using numerical methods, like the Finite Element Method (FEM) \citep{Logg2012}. For some example neuroscience applications, see \cite{Moffitt2005, Frey2009, Joucla2012, Haufe2015, Ness2015, Buccino2019b, Obien2019}. For some simple non-homogeneous cases analytical solutions can still be obtained, for example through the Method of Images for {\it in vitro} brain slices \citep{Ness2015}, and the four-sphere head model for EEG signals (Sec.~\ref{sec:EEG}) \citep{Naess2017}.

\item {\bf No \gex{effects from} ion diffusion:} To account for diffusion of ions, one would need to compute the electrodynamics of the system using one of the electrodiffusive frameworks presented in Section \ref{sec:eldiff}.

\end{enumerate}


\begin{figure}[!ht]
\begin{center}
\includegraphics[width=0.6\textwidth]{frequency_dependence}
\end{center}
\caption{\textbf{Literature review of reported conductivities in various species and experimental setups.} 
Most studies seem to indicate a very weak frequency dependence of the extracellular conductivity, which would have a negligible effect on measured extracellular potentials \citep{Miceli2017}. The very low and strongly frequency dependent values measured by \cite{Gabriel1996} represents an outlier, and although it has received substantial attention, it has to the best of our knowledge not been reproduced by any other study.
For details about the data, see \citep{Miceli2017}, and references therein \citep{Ranck1963, Gabriel1996, Logothetis2007, Elbohouty2013, Wagner2014}
}
\label{fig:freq_dep}
\end{figure}


Volume conductor theory is the fundament for forward modeling of extracellular potentials at different spatial scales, from extracellular spikes, LFPs and MUAs, to ECoGs and EEGs. In the following sections we shall review previous modeling works, and insights from simulating electrical potentials at these different scales.
We use the software LFPy \citep{Linden2014, Hagen2018, Hagen2019}, which has volume conductor theory incorporated and can in principle be used to compute extracellular potentials on arbitrarily large spatial scales, surrounding arbitrarily large neuronal populations. 

\subsection{Modeling electrodes}

The simplest and most commonly used approach when modeling extracellular recordings is to calculate the extracellular potential at single points following one of the approaches outlined above, and use this as a measure of recorded potentials. Implicitly, this 
assumes ideal point electrodes, that is, that the electrodes (and electrode shank) do not affect the extracellular potential and that the extracellular potential does not vary substantially over the surface of the electrodes. (This point-electrode assumption was used for all simulation examples in this chapter).

A numerically straightforward extension is the disc-electrode approximation where the potential is evaluated at a number of points on the electrode surface, and the average calculated \citep{Nunez2006, Linden2014}. \gen{Does Nunez talk about this?}
This approach takes into account the physical extent of the electrode, but not any effect the electrode itself might have on the electric potential. 
Close to the electrode surface the electric potential will however be affected by the presence of the high-conductivity electrode contact \citep{McIntyre2001, Moulin2008}, and
a third, and numerically much more comprehensive approach to modeling electrodes is to use the Finite Element Method (FEM) to model the electrode \citep{Moulin2008, Ness2015}, or the electrode shank \citep{Moffitt2005, Buccino2019b}. Using FEM for validation, \cite{Ness2015} found that the ideal point-electrode and disc-electrode approximations where reasonably accurate when the distance between the current sources and the recording electrode was bigger than $\sim$4 times and $\sim$2 times the electrode radius, respectively, indicating that the effects of the electrodes themselves are negligible in most cases \citep{Nelson2010}.
The presence of large multi-contact electrode probes can, however, substantially affect the extracellular potential in its vicinity, by effectively introducing a large non-conducting volume~\citep{Mechler2012}, and this can amplify or dampen recorded potentials from nearby cells by almost a factor of two, depending on whether the cell is in front of or behind the electrode shank \citep{Buccino2019b}.

Note that for modelling current stimulation electrodes (as opposed to just recording electrodes), more complex electrode models might be needed due to electrode polarization effects \citep{McIntyre2001, Martinsen2008, Joucla2012}.


%\tvntxt{
%The simplest and most commonly used approach to modeling extracellular recording electrodes is to calculate the extracellular potential at single points following one of the approached outlined above, and use this as the recorded potentials. Implicitly, this 
%assumes ideal point electrodes, that is, the electrodes (and electrode shank) does not affect the extracellular potential, and the extracellular potential does not vary substantially over the surface of the electrode (these assumptions were used for all simulation examples in this chapter).
%A straight-forward extension is the disc-electrode approximation where the potential is evaluated at a number of points on the electrode surface, and the average calculated \citep{Nunez2006, Linden2014}. 
%This approach takes into account the physical extent of the electrode, but not any effect the electrode itself might have on the electric potential. 
%Close to the electrode surface the electric potential will however be affected by the presence of the high-conductivity electrode contact \citep{McIntyre2001, Moulin2008}, and
%a third, and much more comprehensive approach to modeling electrodes is to use the Finite Element Method (FEM) to model the electrode \citep{Moulin2008, Ness2015}, or the electrode shank \citep{Moffitt2005, Buccino2019b}. Using FEM for validation, \cite{Ness2015} found that the ideal point-electrode and disc-electrode approximations where reasonable when the distance between the current sources and the recording electrode was bigger than $\sim$4 times and $\sim$2 times the electrode radius, respectively, indicating that the effects of the electrodes themselves is negligible in most cases \citep{Nelson2010}.
%The presence of large multi-contact electrode probes can, however, substantially affect the extracellular potential in its vicinity, by effectively introducing a large non-conducting volume, and this can amplify or dampen recorded potentials from nearby cells by almost a factor of two, depending on if the cell is in front of or behind the electrode shank \citep{Buccino2019b}.
%
%Note that for modelling current stimulation electrodes (as opposed to just recording electrodes), more complex electrode models might be needed due to electrode polarization effects \citep{McIntyre2001, Martinsen2008, Joucla2012}.
%}


\section{Single-cell contributions to extracellular potentials} \label{sec:ExtracellularPotentials}
%\ghnote{Suggest that we start these sections by explaining what $\phi$ tells us at this level. Also, we should refer to the VC-theory and explain which of the assumptions (1-6) that were relaxed in the specific case.}

%\ghnote{Maybe not use current-conservation as a main topic, but rather talk about how extracellular potentials reflect morphology. Say something like: The extracellular potential arising from the activity of a single neuron is a reflection of not only its dynamical activity, but also its  morphology, and neurons with a large spatial extension generally give rise to larger extracellular potentials as there will be larger distances between current.}

%\ghnote{Moved current-conservation figure here. I think that we could call it something else. Perhaps the Hay-neuron-example can be integrated with this figure? And perhaps we should name it single-cell contribution to extracellular potential}.

The transmembrane currents of a neuron during any neural activity can be used to calculate extracellular potentials, by applying the formalism described in Sec.~\ref{sec:VC_theory}, and in the simplest case eq.~\ref{eq:VCtheory}.
%The extracellular potentials from a single neuron is a reflection of both cellular dynamics and morphology (the spatial structure of the cell). 
Current conservation requires that the transmembrane currents across the entire cellular membrane at any given time sum to zero \citep{Koch1999, Nunez2006}, and since
an excitatory synaptic input generates a current sink (negative current), this will necessarily lead to current sources elsewhere on the cell. This implies that point neurons, that is, neurons with no spatial structure, will have no net transmembrane currents, and hence cause no extracellular potentials (Fig.~\ref{fig:EP_morph}A). The simplest neuron models that are capable of producing extracellular potentials are therefore two-compartment models, which will have two equal but opposite transmembrane currents,  
giving rise to perfectly symmetric extracellular potentials (Fig.~\ref{fig:EP_morph}B).
%\tvntxt{. Close to the cell, relative to the distance between the two currents, the extracellular potential from such a model must be described by two current sources (``two-monopole'' model \citep{Linden2010}, but far away, again relative to the distance between the currents, the potential can be described by the current-dipole approximation (eq.~\ref{eq:CDA}).}
%\sout{and cause perfectly dipolar extracellular potentials (Fig.~\ref{fig:EP_morph}B).}

%\gen{Her maa vi vaere litt presise med hva vi mener med dipolar potential. Med en balansert sink og source separert med en avstand $d$, vil dipol-formelen kun gjelde for avstander mye st{\o}rre enn $d$. I Linden2010 kalte vi denne modellen for "two-monopole" modellen for aa ungaa misforstaaelser.}
%\tvnnote{OK with this? Could include short discussion of the effect of the distance between the sink/source, but I felt it was a distraction from the current point that is covered better elsewhere anyway.}

Multi-compartment neuron models mimicking the complex spatial structure of real neurons will typically give rise to complicated patterns of current sinks and sources (negative and positive currents respectively), leading to complex, but mostly dipolar-like extracellular potentials (Fig.~\ref{fig:EP_morph}C) \citep{Einevoll2013}.
Note that this framework for calculating extracellular potentials is valid both for subthreshold and suprathreshold neural activity, that is, when a cell receives synaptic input that does not trigger, or does trigger an action potential, respectively (Fig.~\ref{fig:EP_morph}, D versus E).

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=1\textwidth]{single_cell_EP}
\end{center}
\caption{\textbf{Single-cell contributions to the extracellular potential.} 
{\bf A}: Point neurons have no net currents (top), and therefore cause no extracellular potentials (bottom). 
{\bf B}: Two-compartment neuron models have two opposite currents
of identical magnitude (top), and cause perfectly symmetric dipolar-like extracellular potentials (bottom). 
{\bf C}: Multi-compartment neuron models \citep{Hay2011} give rise to complex source-sink patterns (top) and complex (but mostly dipolar-like) extracellular potentials (bottom). 
{\bf D, E}: A single somatic synaptic input to a complex multi-compartment cell model, either subthreshold (D) or suprathreshold (E; double synaptic weight of D), illustrating that the same framework can be used to calculate both the LFP contribution from subthreshold synaptic input, and extracellular action potentials. 
}
\label{fig:EP_morph}
\end{figure}

\section{Intra-cortical extracellular potentials from neural populations}
Extracellular potentials measured within neural tissue are often split into two separate frequency domains, which reflect different aspects of the underlying neural activity. 
The low frequency part, that is, the local field potential (LFP), is thought to mostly reflect synaptic input to populations of pyramidal cells, while the high-frequency part, that is, the multi-unit activity (MUA), reflects the population spiking activity (Fig.~\ref{fig:LFP_MUA}).

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=1\textwidth]{population_LFP_MUA.png}
%\includegraphics[width=1\textwidth]{PC_versus_IN}
\end{center}
\caption{\textbf{Extracellular potentials from different waves of synaptic input}. Different brain signals from separate waves of synaptic input to 10 000 layer 5 pyramidal cells from rat \citep{Hay2011}.
{\bf A}: A subset of 100 pyramidal cells, with the LFP electrode locations indicated in the center (colored dots).
{\bf B}: Depth-resolved synaptic inputs arrive in three waves, first targeting the basal dendrites (t=100~ms), then the apical dendrites (t=200~ms), and lastly uniformly across the entire depth (t=300~ms). Note that all synaptic input is pre-defined, that is, there is no network activity.
{\bf C}: The extracellular potential at different depths (corresponding to dots in panel A), including both spikes and synaptic input.
{\bf D}: The LFP, that is, a low-pass filtered version of the raw signal in C. 
{\bf E}: The MUA, that is, a high-pass filtered version of the raw signal in C.
{\bf F}: Another version of the MUA which is a rectified and low-pass filtered version of the MUA signal in E.
All filters where 4th order Butterworth filters in forward-backward mode \citep{NeuroEnsamble2017}. For illustration purposes a relatively low cut-off frequency of 50~Hz was chosen for the LFP low-pass filter. The MUA was first high-pass filtered above 300~Hz (E and F), then rectified and low-pass filtered below 300 Hz (F).
}
\label{fig:LFP_MUA}
\end{figure}


\subsection{Local field potentials}
%\tvnnote{Find place to put sentence or two on importance of correlation.}
The LFP is the low-frequency part ($\lesssim$ 500~Hz) of the extracellular potentials, and it is among the oldest and most used brain signals in neuroscience \citep{Einevoll2013}. The LFP is expected to be dominated by \gex{synaptic inputs asymmetrically placed onto populations} of geometrically aligned neurons \citep{Nunez2006, Linden2011, Einevoll2013b}.
In cortex and hippocampus, neurons can broadly speaking be divided into two main classes: the inhibitory interneurons, and the excitatory pyramidal neurons. Pyramidal neurons typically have a clear axis of orientation, that is, the apical dendrites of close-by pyramidal neurons tend to be oriented in the same direction (Fig.~\ref{fig:LFP_MUA}A). This geometrical alignment is important because the LFP contributions from the individual pyramidal cells also align and therefore sum constructively.  For example, basal excitatory synaptic input (Fig.~\ref{fig:LFP_MUA}B, time marked by red line) generates a current sink and corresponding negative LFP deflection in the basal region, and simultaneously a current source and corresponding positive LFP deflection in the apical region (Fig.~\ref{fig:LFP_MUA}D, time marked by red line), while apical excitatory synaptic input leads to the reversed pattern (Fig.~\ref{fig:LFP_MUA}B,D, time marked by blue line). 
Importantly, this means that excitatory input that simultaneously targets both the apical and the basal dendrite will give opposite source/sink patterns which will lead to substantial cancellation and a weak LFP contribution (Fig.~\ref{fig:LFP_MUA}B, D, time marked by orange line).
The same arguments also apply to inhibitory synaptic inputs, with the signs of the currents and LFPs reversed. 

Note that, for example, the LFP signature of apical excitatory synaptic input is inherently similar to that of basal inhibitory input, and indeed, separating between cases like this pose a real challenge in interpreting LFP signals \citep{Linden2010}. 

In contrast to pyramidal neurons, interneurons often lack any clear orientational specificity, meaning that the current dipoles from individual interneurons, which might by themselves be sizable \citep{Linden2010}, do not align, leading to negligible net contributions to LFP 
signals~\citep{Mazzoni2015}.
\gex{Note, however, that the interneurons may indirectly cause large LFP contributions through their 
synaptic inputs onto pyramidal cells \citep{Telenczuk2016, Hagen2016}.}
%\gen{Dette forutsetter vel at input-synapsene er jevnt fordelt over hele nevronet? Som vist i Linden2010 saa kan enkelt-input til stellate cells ogsaa gi dipoler.}
%\tvnnote{Det er egentlig det jeg mener med ``lack orientational specificity''. Enkelt-celler har dipoler, men de summerer ikke konstruktivt for populasjoner. Greit naa?}

It has been demonstrated that correlations among the synaptic inputs to pyramidal cells can amplify the LFP signal power by orders of magnitude, with the implication that populations receiving correlated synaptic input can dominate the LFP also 1-2~mm outside of the population \citep{Linden2011, Leski2013}.

\gex{Somatic action potentials lasting only a few milliseconds are generally expected to contribute little to cortical LFP signals 
\citep{Pettersen2008,Pettersen2008a,Einevoll2013, Haider2016}:  Their very short duration with both positive and negative phases (Fig.~\ref{fig:EP_morph}E) will typically give large signal cancellations of the contributions from individual neurons, and their high frequency content is to a large degree removed from LFPs during low-pass filtering. Note however, that in the hippocampus the highly synchronized spikes found during sharp wave ripples are expected to 
contribute to shaping also the LFP \citep{Schomburg2012, Luo2018}.} 

\gex{However, other active conductances may contribute in shaping the LFP, for example, the slower dendritic calcium 
spikes \citep{Suzuki2017} or long-lasting after-hyperpolarization currents~\citep{Reimann2013}. Further, 
subthreshold active conductances can also shape the LFP by molding the transmembrane currents following synaptic input, and the hyperpolarization-activated cation channel I$_{\rm h}$ may play a key role in this, both through asymmetrically changing the membrane conductance, and by introducing apparent resonance peaks in the LFP \citep{Ness2016, Ness2018}.}




%%Although the LFP is believed to predominantly reflect \tvntxt{dendritic processing of} synaptic inputs, active conductances may also contribute to its shaping.
%\tvntxt{Active conductances may also contribute to shaping the LFP,}
%and especially slower conductances may play a key role in this, such as dendritic calcium spikes \citep{Suzuki2017} and long-lasting after-hyperpolarization currents \citep{Reimann2013}. Note that somatic
%action potentials are typically expected to contribute little to cortical LFP signals for several reasons \citep{Einevoll2013, Haider2016}. For example, their very short duration with both positive and negative phases (Fig.~\ref{fig:EP_morph}E) would require extreme synchrony to sum constructively in the LFP, and their high frequency content is to a large degree removed from LFPs during low-pass filtering. Note however, that in the hippocampus the highly synchronized spikes found during sharp wave ripples are expected to strongly shape the LFP \citep{Schomburg2012, Luo2018}. 
%
%Subthreshold active conductances can also shape the LFP by molding the transmembrane currents following synaptic input, and the hyperpolarization-activated cation channel I$_{\rm h}$ may play a key role in this\tvntxt{, both through asymmetrically changing the membrane conductance, and by introducing apparent resonance peaks in the LFP} \citep{Ness2016, Ness2018}.


%\tvntxt{, both through somatic and dendritic spikes, and through subthreshold molding of the transmembrane currents.}
%\gen{Her kan det hoeres det ut som active conductances staar i motsetning til synaptic conductances. Tror dette boer forklares litt mer detaljert:
%(i) active conductances kan gi en DC LFP selv uten synaptisk input, (ii) active conductances paavirker responsen til synaptisk input baade ved at den "passive" membranresistansen oeker og at det kan komme inn mer fancy resonanseffekter etc.}
%\tvnnote{I rewrote this, but I have not added so much more info on the effect of Ih, since it feels a bit biased to devote that much space to it in a book chapter?}
%Especially slower conductances may play a key role in this, such as long-lasting after-hyperpolarization currents \citep{Reimann2013}, calcium spikes \citep{Suzuki2017}, or the hyperpolarization-activated cation channel I$_{\rm h}$ \citep{Ness2016, Ness2018}. Action potentials are typically expected to contribute little to cortical LFP signals for several reasons \citep{Einevoll2013, Haider2016}, for example, their very short duration with both positive and negative phases (Fig.~\ref{fig:EP_morph}E) would require extreme synchrony to sum constructively in the LFP, and their high frequency content is to a large degree removed from LFPs during low-pass filtering. Note however, that in the hippocampus the highly synchronized spikes found during sharp wave ripples are expected to strongly shape the LFP \citep{Schomburg2012, Luo2018}. 

%\subsubsection*{Other approaches}
%\tvnnote{Make this section one sentence in LFP}.
%Kernels \citep{Hagen2016}
%Proxies \cite{Mazzoni2015}
%LFP Kernels from experimental spike-triggered averages (Destexhe?)



\subsection{MUA}
While LFPs are thought to mainly reflect the synaptic input to large populations of pyramidal neurons, the multi-unit activity (MUA) can be used to probe the population spiking activity \citep{Einevoll2007,Pettersen2008} (Fig.~\ref{fig:LFP_MUA} E,F). In other words, the MUA holds complimentary information to the LFP. In particular, this can be useful for some cell-types, like stellate cells and \gex{inhibitory} interneurons, which are expected to have very weak LFP contributions \citep{Linden2011}, but might still be measurable through their spiking activity. 
Similarly, spatially uniformly distributed synaptic input to pyramidal neurons results in a negligible LFP contribution (Fig.~\ref{fig:LFP_MUA}C, time marked by orange line), while the population might still contribute substantially to the MUA through the extracellular action potentials (Fig.~\ref{fig:LFP_MUA}E-F, time marked by orange line). 
%\gen{Men MUA er jo nyttig ogsaa for pyramidal-nevroner som genererer LFP siden den gir ekstra informasjon, dvs. direkte maal paa spiking output.}
%\tvnnote{Hva med naa?}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{ECoG and EEG}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{sec:EEG}
In order to measure electric potentials in the immediate vicinity of neurons, like LFP and MUA signals,
%\slntxt{(OR better: LFP and MUA signals)}
%\snnote{$<-$ Torbjorn, which one do you prefer?}
%\tvnnote{I liked both :-)}
we need to insert sharp electrodes into the brain. This highly invasive technique is quite common in animal studies, but can only be applied to humans when there is a clear medical need, for example in patients with intractable epilepsy \citep{Zangiabadi2019}. However, electric potentials generated by neural activity extend beyond neural tissue and can also be measured outside the brain:
Placing electrodes on the brain surface, as in electrocorticography (ECoG), is a technique that requires some surgery. With electroencephalograpjhy (EEG), on the other hand, potentials are measured non-invasively, directly on top of the scalp.


%The first technique is known as electrocorticography (ECoG), while the second refers to the non-invasive method of electroencephalography (EEG)
%Fortunately, electric potentials generated by neural activity extend beyond neural tissue and can be picked up by electrodes placed on the brain surface or on top of the scalp. The first technique is known as electrocorticography (ECoG), while the second refers to the non-invasive method of electroencephalography (EEG). 


Since EEG electrodes are located relatively far away from the neuronal sources, the current dipole approximation, eq.~\eqref{eq:CDA}, combined with some head model, can be applied for computing EEG signals \citep{Nunez2006,Ilmoniemi2019}. By collapsing the transmembrane currents of a neuron simulation into one single current dipole moment, see eq.~\eqref{eq:dipole}, we can calculate EEG from arbitrary neural activity (Fig.~\ref{fig:multimodal}).

The current dipole approximation is however not unproblematic to use for computing ECoG signals, as the ECoG electrodes may be located too close to the 
signal sources for the approximation to apply, see \cite{Hagen2018}.


\begin{figure}[!ht]
\begin{center}
\includegraphics[width=0.5\textwidth]{population_EEG_MEG_cut.png}
%\includegraphics[width=1\textwidth]{PC_versus_IN}
\end{center}
\caption{\textbf{Extracellular potentials from different waves of synaptic input}. Different brain signals from separate waves of synaptic input to 10 000 layer 5 pyramidal cells from rat \citep{Hay2011}.
{\bf A}: The four-sphere head model with two orientations of the neural population, either radial, mimicking a population in a gyrus (top) or tangential, mimicking a population in a sulcus (bottom).
{\bf B}: A snapshot of the EEG signal at the head surface for apical input (time marked with blue dotted line in Fig. \ref{fig:LFP_MUA}), for a radial population (top) or tangential population (bottom).
}
\label{fig:EEG_MEG}
\end{figure}

\subsection{Head models}
Electric potentials measured on the scalp surface will be affected by the geometries and conductivities of the different constituents of the head \citep{Nunez2006}. This can be incorporated in EEG calculations by applying simplified or more complex head models.
A well-known simplified head model is the analytical four-sphere model, consisting of four concentric shells representing brain tissue, cerebrospinal fluid (CSF), skull and scalp, where the conductivity can be set individually for each shell \citep{Naess2017, Srinivasan1998, Nunez2006} (Fig.~\ref{fig:foursphere_contour}, Fig.~\ref{fig:head_models}A,B).
More complex head models make use of high-resolution anatomical MRI-data to map out a geometrically detailed head volume conductor. The link between current dipoles in the brain and resulting EEG signals is determined applying numerical methods such as the finite element method \citep{Larson2013, Logg2012}. Once this link is established we can in principle insert a dipole representing arbitrary neural activity into such a model, and compute the resulting EEG signals quite straightforwardly. The New York Head model is an example of one such pre-solved complex head model, see Fig.~\ref{fig:head_models}C,D \citep{Huang2016}.

The head models themselves introduce no essential frequency filtering of the EEG signal \citep{Pfurtscheller1975, Nunez2006, Ranta2017}, however, substantial spatial filtering will occur (Fig.~\ref{fig:foursphere_contour}). Additionally, the measured (or modeled) signals represent the average potential across the elecrode surface, and the large electrode sizes used in ECoG/EEG recordings can have important effect on the measured signals \citep{Nunez2006, Hagen2018, Dubey2019}.
%\snnote{Torbjorn: Was it something in the means of the last sentence above, that you had in mind? Do you have any suggestions for papers to cite? Feel free to make changes!} \tvnnote{OK?}
%
%Can use analytic four-sphere (Fig. \ref{fig:head_models}A) \citep{Hagen2018, Naess2017}
%Can also used pre-solved complex head models, like the New York head (Fig. \ref{fig:head_models}B) \citep{Huang2016}.
%
%No important frequency  filtering on EEG signal by head \citep{Pfurtscheller1975, Ranta2017}, however, substantial spatial filtering (Fig.~\ref{fig:foursphere_contour}).

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=1.0\textwidth]{4o_contour}
%\includegraphics[width=1\textwidth]{PC_versus_IN}
\end{center}
\caption{\textbf{Effect of head inhomogeneities}.
The same current dipole will give substantially different potentials on the head surface if the different conductivities of the head is included in a FEM model  \citep{Naess2017}. Left: Homogeneous sphere, with electrical conductivity, $\sigma=0.33$~S/m everywhere. Right: Standard four-sphere head model, with $\sigma_{\text{brain}}=0.33$~S/m, $\sigma_{\text{CSF}}=5\sigma_{\text{brain}}$, 
$\sigma_{\text{skull}}=\sigma_{\text{brain}} / 20$, $\sigma_{\text{scalp}}=\sigma_{\text{brain}}$.
}
\label{fig:foursphere_contour}
\end{figure}

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=0.6\textwidth]{head_models.pdf}
\end{center}
\caption{\textbf{The four-sphere head model and the NY Head model}. EEG signals from population dipole resulting from waves of synaptic input to 10 000 layer 5 pyramidal cells from rat \citep{Hay2011}.
	{\bf A}: The four-sphere model consisting of four concentrical shells: brain, CSF, skull and scalp. 
	{\bf B}: Maximum EEG signals ($\phi$) on scalp surface electrodes resulting from population dipole placed at location marked by orange star, computed with the four-sphere model.
	{\bf C}: Illustration of the New York Head model.
	{\bf D}: EEG signals computed with the New York Head model, equivalent to panel {\bf B}.
}
\label{fig:head_models}
\end{figure}


%\section{Inverse modeling}
%
%\gen{Gaute: I will write this}
%\gen{Have to think more about what it shall contain}



%\section{Software tools}
%LFPy etc.
%\tvnnote{Recycle text from LFPy 2.0 paper about other softwares, sec 4.7?}
%\tvnnote{Maybe we don't need this section? Just say that 'here we've used LFPy'}
%\gen{I suggest we just list other tools that computes brain signals (NetPyne, BMTK, Human Brain Solver, VISAPy, VIMEAPy, MEARec, .....?).}

\section{Discussion}
\label{sec:summary}

In the present chapter we have derived and applied well-established biophysical forward-modeling schemes for computing extracellular electrical potentials recorded inside and outside the brain. These electrical potentials include spikes (both single-unit and multiunit activity (MUA)), LFP, ECoG and EEG signals. The obvious application of this scheme is computation of electrical signals from neuron and network activity for comparison with experiments so that candidate models can be tested~\citep{Einevoll2019} or inferred~\citep{Goncalves2019,Skaar2020}.
Another key application is the computation of benchmarking data for testing of data analysis methods such as 
spike sorting or CSD analysis~\citep{Denker2012}. 

Inverse modeling of recorded electrical potentials, that is, estimation of the neural sources underlying the signals, is inherently an ill-posed problem. This means that no unique solution for the size and position of the sources exists. However, prior knowledge about the underlying sources and how they generate the recorded signals, can be used to increase the identifiability. For example, several methods for the estimation of so-called current-source density (CSD) from LFP recordings have been developed by building the present forward model into the CSD 
estimator~\citep{Pettersen2006,Potworowski2012,Cserpan2017}.

The present chapter has focused on the modeling of measurements of extracellular electrical signals. Another important and related brain signal
is the magnetic fields recorded outside the head in magnetoencephalograpy (MEG). These magnetic signals also stem from the transmembrane currents of neurons and, similar to EEG, the signal can be computed based on the current dipoles of the underlying neurons in 
cortex~\citep{Hamalainen1993,Ilmoniemi2019}. The new version of our tool LFPy, which was used in generating the examples in the present chapter, thus also includes the ability to compute MEG signals~\citep{Hagen2018}. 

There are also other measurement modalities where detailed modeling could be pursued to allow for a more quantitative analysis of recorded data. Voltage-sensitive dye imaging (VSDI) reflects area-weighted neuronal membrane potentials~\citep{Chemla2012}, while two-photon calcium imaging measures the intracellular calcium dynamics~\citep{Helmchen2012}. Both are accessible through neuronal simulations of the type used to compute electrical and magnetic signals. Functional magnetic resonance imaging (fMRI) instead reflect blood dynamics~\citep{Bartels2012}, 
which typically are not explicitly included in neural network models.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Acknowledgements}
\label{sec:acknowledgements}
This research has received funding from the European Union Horizon 2020 Framework Programme for Research
and Innovation under Specific Grant Agreement No. 785907 (Human Brain Project SGA2), and the Research Council of Norway (Notur, nn4661k; DigiBrain, no. 248828; INCF National Node, no. 269774).



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{References}
\label{sec:bibliography}
\bibliography{ECS_bookchapter}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\end{document}  
